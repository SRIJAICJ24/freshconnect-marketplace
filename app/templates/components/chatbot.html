<!-- AI Chatbot Widget -->
<div class="chatbot-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <!-- Chat Button -->
    <button id="chatbot-toggle" class="chatbot-btn">
        <i class="fas fa-robot"></i>
        <span class="chatbot-badge">AI</span>
    </button>
    
    <!-- Chat Window -->
    <div id="chatbot-window" class="chatbot-window">
        <div class="chatbot-header">
            <div class="d-flex align-items-center">
                <div class="chatbot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ms-3">
                    <h6 class="mb-0 fw-bold">AI Assistant</h6>
                    <small class="text-white-50">Powered by Gemini</small>
                </div>
            </div>
            <button id="chatbot-close" class="chatbot-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chatbot-body" id="chatbot-messages">
            <div class="chatbot-welcome">
                <div class="welcome-icon">
                    <i class="fas fa-sparkles"></i>
                </div>
                <strong>Hi there! üëã</strong>
                <p>I'm your FreshConnect AI assistant powered by Google Gemini.</p>
                <p>‡Æ®‡Ææ‡Æ©‡Øç ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç English-‡Æ≤‡Øç ‡Æ™‡Æ§‡Æø‡Æ≤‡Æ≥‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç!</p>
            </div>
        </div>
        <div class="chatbot-footer">
            <div class="chatbot-input-group">
                <input type="text" id="chatbot-input" class="chatbot-input" placeholder="Ask me anything...">
                <button id="chatbot-send" class="chatbot-send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Modern Chatbot Styling */
.chatbot-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    animation: pulse 2s infinite;
}

.chatbot-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 15px 40px rgba(16, 185, 129, 0.6);
}

.chatbot-btn:active {
    transform: scale(0.95);
}

.chatbot-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    border: 3px solid white;
    box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4);
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    }
    50% {
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.7);
    }
}

.chatbot-window {
    display: none;
    width: 380px;
    height: 550px;
    position: fixed;
    bottom: 100px;
    right: 20px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chatbot-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chatbot-avatar {
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
}

.chatbot-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chatbot-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.chatbot-body {
    height: 400px;
    overflow-y: auto;
    padding: 1.5rem;
    background: #f9fafb;
}

.chatbot-body::-webkit-scrollbar {
    width: 6px;
}

.chatbot-body::-webkit-scrollbar-track {
    background: #f3f4f6;
}

.chatbot-body::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-radius: 10px;
}

.chatbot-welcome {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%);
    border-left: 4px solid #10b981;
    padding: 1.25rem;
    border-radius: 12px;
    color: #1f2937;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
}

.welcome-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-bottom: 0.75rem;
}

.chatbot-welcome strong {
    display: block;
    color: #10b981;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.chatbot-welcome p {
    margin: 0.25rem 0;
    color: #4b5563;
    font-size: 0.9rem;
}

.chatbot-footer {
    padding: 1rem 1.5rem;
    background: white;
    border-top: 2px solid #f3f4f6;
}

.chatbot-input-group {
    display: flex;
    gap: 0.75rem;
}

.chatbot-input {
    flex: 1;
    padding: 0.875rem 1.25rem;
    border: 2px solid #e5e7eb;
    border-radius: 25px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.chatbot-input:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.chatbot-send-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}

.chatbot-send-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
}

.chatbot-send-btn:active {
    transform: scale(0.95);
}

/* Message Bubbles */
.chatbot-message-user {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 0.875rem 1.25rem;
    border-radius: 18px 18px 4px 18px;
    margin-left: 20%;
    margin-bottom: 0.75rem;
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
    word-wrap: break-word;
}

.chatbot-message-bot {
    background: white;
    color: #1f2937;
    padding: 0.875rem 1.25rem;
    border-radius: 18px 18px 18px 4px;
    margin-right: 20%;
    margin-bottom: 0.75rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
    word-wrap: break-word;
}

.chatbot-message-bot a {
    color: #10b981;
    font-weight: 600;
    text-decoration: none;
    border-bottom: 2px solid #10b981;
}

.chatbot-message-bot a:hover {
    color: #059669;
    border-bottom-color: #059669;
}

.chatbot-message-error {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    padding: 0.875rem 1.25rem;
    border-radius: 18px;
    margin-bottom: 0.75rem;
    box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2);
}

.chatbot-typing {
    background: white;
    color: #6b7280;
    padding: 0.875rem 1.25rem;
    border-radius: 18px 18px 18px 4px;
    margin-right: 20%;
    margin-bottom: 0.75rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
    font-style: italic;
}

/* Mobile Responsive */
@media (max-width: 480px) {
    .chatbot-window {
        width: calc(100vw - 40px);
        height: calc(100vh - 120px);
        bottom: 90px;
        right: 20px;
        left: 20px;
    }
    
    .chatbot-btn {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
}
</style>

<script>
// Chatbot Widget JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('chatbot-toggle');
    const window = document.getElementById('chatbot-window');
    const close = document.getElementById('chatbot-close');
    const input = document.getElementById('chatbot-input');
    const send = document.getElementById('chatbot-send');
    const messages = document.getElementById('chatbot-messages');
    
    // Toggle chat window
    toggle.addEventListener('click', () => {
        window.style.display = window.style.display === 'none' ? 'block' : 'none';
    });
    
    close.addEventListener('click', () => {
        window.style.display = 'none';
    });
    
    // Send message
    function sendMessage() {
        const message = input.value.trim();
        if (!message) return;
        
        // Add user message
        addMessage(message, 'user');
        input.value = '';
        
        // Show typing indicator
        const typing = addMessage('Typing...', 'bot');
        
        // Call AI API
        fetch('/api/chatbot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        })
        .then(r => r.json())
        .then(data => {
            typing.remove();
            
            // Handle different response types from SmartChatbotService
            if (data.type === 'search_results') {
                let html = `<strong>${data.message}</strong><br>`;
                if (data.results && data.results.length > 0) {
                    data.results.forEach(r => {
                        html += `‚Ä¢ ${r.name}: ‚Çπ${r.price}/${r.unit} (${r.vendor})<br>`;
                    });
                    html += `<a href="${data.redirect}" style="color: #28a745; text-decoration: underline;">‚Üí ${data.action}</a>`;
                }
                addMessage(html, 'bot', true);
            } else if (data.type === 'order_list') {
                let html = `<strong>${data.message}</strong><br>`;
                if (data.recent_orders && data.recent_orders.length > 0) {
                    data.recent_orders.forEach(o => {
                        html += `‚Ä¢ Order #${o.id}: ${o.status} - ‚Çπ${o.amount}<br>`;
                    });
                    html += `<a href="${data.redirect}" style="color: #28a745; text-decoration: underline;">‚Üí ${data.action}</a>`;
                }
                addMessage(html, 'bot', true);
            } else if (data.type === 'credit_info') {
                let html = `<strong>${data.message}</strong><br>`;
                html += `Tier: ${data.tier}<br>`;
                html += `<a href="${data.redirect}" style="color: #28a745; text-decoration: underline;">‚Üí ${data.action}</a>`;
                addMessage(html, 'bot', true);
            } else if (data.type === 'help') {
                let html = `<strong>${data.message}</strong><br>`;
                if (data.examples && data.examples.length > 0) {
                    html += '<br><em>Try:</em><br>';
                    data.examples.forEach(ex => {
                        html += `‚Ä¢ ${ex}<br>`;
                    });
                }
                addMessage(html, 'bot', true);
            } else if (data.type === 'text' || data.message) {
                addMessage(data.message, 'bot');
            } else if (data.response) {
                // Fallback for simple chatbot responses
                addMessage(data.response, 'bot');
            } else if (data.error) {
                addMessage('Error: ' + data.error, 'error');
            } else {
                addMessage('Sorry, I could not process that request.', 'error');
            }
        })
        .catch(err => {
            typing.remove();
            addMessage('Connection error. Please try again.', 'error');
        });
    }
    
    send.addEventListener('click', sendMessage);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    
    function addMessage(text, type, isHTML = false) {
        const div = document.createElement('div');
        
        if (type === 'user') {
            div.className = 'chatbot-message-user';
        } else if (type === 'error') {
            div.className = 'chatbot-message-error';
        } else if (type === 'bot' && text === 'Typing...') {
            div.className = 'chatbot-typing';
        } else {
            div.className = 'chatbot-message-bot';
        }
        
        // Use innerHTML for HTML content, textContent for plain text
        if (isHTML) {
            div.innerHTML = text;
        } else {
            div.textContent = text;
        }
        
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        return div;
    }
});
</script>

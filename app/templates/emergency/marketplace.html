{% extends 'base.html' %}

{% block title %}Emergency Marketplace - FreshConnect{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 style="color: #dc3545;">
                <i class="fas fa-fire"></i> Emergency Marketplace
            </h1>
            <p class="text-muted">Special deals on products expiring soon - Save up to 70%!</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>You Save: ₹{{ "{:,.0f}".format(total_savings) }}</h5>
                    <p class="mb-0">{{ total_products }} deals available</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <!-- Category Filter -->
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select name="category" class="form-select">
                                <option value="">All Categories</option>
                                {% for cat in categories %}
                                <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Discount Filter -->
                        <div class="col-md-3">
                            <label class="form-label">Minimum Discount</label>
                            <select name="min_discount" class="form-select">
                                <option value="0" {% if selected_discount == 0 %}selected{% endif %}>Any Discount</option>
                                <option value="25" {% if selected_discount == 25 %}selected{% endif %}>25%+</option>
                                <option value="40" {% if selected_discount == 40 %}selected{% endif %}>40%+</option>
                                <option value="50" {% if selected_discount == 50 %}selected{% endif %}>50%+</option>
                            </select>
                        </div>
                        
                        <!-- Sort -->
                        <div class="col-md-3">
                            <label class="form-label">Sort By</label>
                            <select name="sort" class="form-select">
                                <option value="urgency" {% if sort_by == 'urgency' %}selected{% endif %}>Most Urgent</option>
                                <option value="discount" {% if sort_by == 'discount' %}selected{% endif %}>Highest Discount</option>
                                <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Recently Added</option>
                                <option value="vendor" {% if sort_by == 'vendor' %}selected{% endif %}>By Vendor</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Products Grid -->
    <div class="row">
        {% if products %}
            {% for product in products %}
            {% set urgency = product.get_emergency_status() %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm" style="border-left: 5px solid #dc3545;">
                    <!-- Product Image -->
                    <div style="position: relative;">
                        <img src="https://via.placeholder.com/300x200?text={{ product.product_name }}" 
                             class="card-img-top" alt="{{ product.product_name }}" style="height: 150px; object-fit: cover;">
                        
                        <!-- Urgency Badge -->
                        {% if urgency %}
                        <span class="badge bg-{{ urgency.color }} position-absolute top-0 end-0 m-2">
                            {{ urgency.icon }} {{ urgency.status }}
                        </span>
                        {% endif %}
                        
                        <!-- Discount Badge -->
                        <span class="badge bg-danger position-absolute top-0 start-0 m-2">
                            -{{ product.emergency_discount }}%
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <h5 class="card-title">{{ product.product_name }}</h5>
                        <p class="text-muted">
                            <i class="fas fa-store"></i> {{ product.vendor.business_name }}
                        </p>
                        
                        <!-- Pricing -->
                        <div class="mb-2">
                            <span class="text-muted" style="text-decoration: line-through;">
                                ₹{{ "%.2f"|format(product.original_price_backup or product.price) }}/{{ product.unit }}
                            </span>
                            <br>
                            <span class="h5 text-success">
                                <strong>₹{{ "%.2f"|format(product.price) }}/{{ product.unit }}</strong>
                            </span>
                        </div>
                        
                        <!-- Quantity & Expiry -->
                        {% if urgency %}
                        <div class="alert alert-warning mb-2" style="font-size: 0.9rem;">
                            <i class="fas fa-hourglass-end"></i> 
                            <strong>{{ urgency.message }}</strong><br>
                            <i class="fas fa-cube"></i> 
                            Available: {{ product.quantity }} {{ product.unit }}
                        </div>
                        {% endif %}
                        
                        <!-- Action -->
                        <a href="{{ url_for('emergency.product_detail', product_id=product.id) }}" class="btn btn-danger w-100 btn-sm">
                            <i class="fas fa-shopping-cart"></i> View & Add to Cart
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <h5>No emergency products available right now</h5>
                    <p>Check back soon for great deals on expiring products!</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
.card {
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-5px);
}
</style>
{% endblock %}
